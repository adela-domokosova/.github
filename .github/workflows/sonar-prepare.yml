name: Prepare analysis context

on:
  workflow_call:
    inputs:
      workflow_run:
        description: Associated workflow_run event
        type: string
        required: true
    outputs:
      sonar_allowed:
        description: Whether the analysis is allowed
        value: ${{ jobs.prepare.outputs.sonar_allowed }}
      pull_request:
        description: Associated pull_request event
        value: ${{ jobs.prepare.outputs.pull_request }}


permissions:
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    name: Prepare context
    outputs:
      sonar_allowed: ${{ steps.export.outputs.sonar_allowed }}
      pull_request: ${{ steps.export.outputs.pull_request }}
    steps:
      - name: Fetch pull_request
        if: fromJSON(inputs.workflow_run).event == 'pull_request'
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: pull_request
          run-id: ${{ fromJSON(inputs.workflow_run).id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Export context values
        id: export
        shell: bash
        env:
          TRIGGER_EVENT: ${{ inputs.workflow_run }}
        run: |
          SONAR_ALLOWED=false
          OWNER=$(echo '${{ inputs.workflow_run }}' | jq -r '.head_repository.owner.login')

          
          if [ -f pull_request.json ]; then
            echo "pull_request=$(cat pull_request.json | jq -c .)" >> "$GITHUB_OUTPUT"

            if [[ "$OWNER" == "WrenSecurity" ]] && jq -e '.base.ref == "main"' pull_request.json; then
              SONAR_ALLOWED=true
            fi
          fi

          if [[ "$OWNER" == "WrenSecurity" ]] && $(echo "$TRIGGER_EVENT" | jq -e '.event == "push" and .head_branch == "main"'); then
            SONAR_ALLOWED=true
          fi

          echo "sonar_allowed=$SONAR_ALLOWED" >> "$GITHUB_OUTPUT"
